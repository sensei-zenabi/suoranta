<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BUDOSTACK</title>

  <!-- Fonts + Styles -->
  <link rel="stylesheet" href="style.css" />
  <meta name="theme-color" content="#40318d">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <!-- Background layers -->
  <div class="bg print-grain"></div>
  <div class="bg ribbon ribbon-top"></div>
  <div class="bg ribbon ribbon-bottom"></div>

  <header class="site-header">
    <div class="hero">
      <div class="crest">
        <span class="crest-mark">C</span>
        <span class="crest-lines"></span>
      </div>
      <div class="hero-copy">
        <div class="logo">BUDOSTACK</div>
        <p class="tag">
          Operating System for those who appriciate maximum
          efficiency on basic primitives of computing.
        </p>
      </div>
    </div>
    <nav class="nav">
      <a class="retro-btn" href="https://github.com/sensei-zenabi/BUDOSTACK/tags">Releases</a>
      <a class="retro-btn" href="#about" id="about-btn">Newsroom</a>
      <a class="retro-btn" href="#feed" id="feed-btn">Commit Log</a>
    </nav>
  </header>

  <div class="content">
    <!-- FEED gets populated from README -->
    <main class="container" id="feed">
      <noscript>
        <article class="card">
          <h2 class="post-title"><span class="jpn">オフライン</span> JavaScript Disabled</h2>
          <p class="meta">Enable JavaScript to view the live commit feed.</p>
        </article>
      </noscript>
    </main>

    <section class="about container hidden" id="about">
      <h2 class="section-title">BUDOSTACK News</h2>
      <img src="images/about.png" alt="About" class="about-photo">
      <div id="news-content" class="news-content">
        <p>Loading latest news...</p>
      </div>
    </section>
  </div>

  <footer class="site-footer">
    <p>© 2025 BUDOSTACK // Ville Suoranta</p>
  </footer>

  <script>
    // ========= CONFIG =========
    const NEWS_SOURCE_URL = 'https://raw.githubusercontent.com/sensei-zenabi/BUDOSTACK/main/users/ville/readme.md';

    const OWNER = 'sensei-zenabi';
    const REPO = 'BUDOSTACK';
    const BRANCH = 'main';
    const COMMITS_PER_PAGE = 10;

    const COMMITS_PAGE_URL = `https://github.com/${OWNER}/${REPO}/commits/${BRANCH}`;
    const COMMITS_API_URL = `https://api.github.com/repos/${OWNER}/${REPO}/commits?sha=${BRANCH}&per_page=${COMMITS_PER_PAGE}`;

    const CACHE_KEY = `commit_log_cache_v2:${OWNER}/${REPO}/${BRANCH}`;
    const CACHE_TTL_MS = 15 * 60 * 1000;
    const API_HEADERS = { 'Accept': 'application/vnd.github+json' };

    const newsContentEl = document.getElementById('news-content');

    async function loadNews() {
      if (!newsContentEl) return;
      newsContentEl.innerHTML = '<p>Loading latest news...</p>';
      try {
        const response = await fetch(NEWS_SOURCE_URL, { headers: { 'Accept': 'text/plain' } });
        if (!response.ok) throw new Error(`Failed to load news: ${response.status}`);

        const markdown = await response.text();
        const rendered = DOMPurify.sanitize(marked.parse(markdown));
        newsContentEl.innerHTML = rendered;
      } catch (err) {
        console.error(err);
        newsContentEl.innerHTML = '<p class="error">Unable to load news right now. Please try again later.</p>';
      }
    }

    loadNews();

    const feedEl = document.getElementById('feed');
    feedEl.innerHTML = '';

    const feedListEl = document.createElement('div');
    feedListEl.className = 'feed-list';
    feedEl.appendChild(feedListEl);

    const loadMoreContainer = document.createElement('div');
    loadMoreContainer.className = 'load-more-container hidden';

    const loadMoreButton = document.createElement('button');
    loadMoreButton.type = 'button';
    loadMoreButton.className = 'neon-btn load-more-btn';
    loadMoreButton.textContent = 'LOAD MORE COMMITS';
    loadMoreContainer.appendChild(loadMoreButton);

    const loadMoreStatus = document.createElement('p');
    loadMoreStatus.className = 'load-more-status hidden';
    loadMoreStatus.setAttribute('role', 'status');
    loadMoreContainer.appendChild(loadMoreStatus);

    feedEl.appendChild(loadMoreContainer);

    const state = {
      pages: new Map(),
      currentPage: 0,
      hasMore: true,
      isLoading: false
    };

    const DAY_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const MONTH_NAMES = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    function escapeHtml(value = '') {
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatCommitDate(isoString) {
      if (!isoString) return 'Unknown';
      const date = new Date(isoString);
      if (Number.isNaN(date.getTime())) return isoString;

      const dayName = DAY_NAMES[date.getDay()];
      const monthName = MONTH_NAMES[date.getMonth()];
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      const year = date.getFullYear();

      const offsetMinutes = -date.getTimezoneOffset();
      const offsetSign = offsetMinutes >= 0 ? '+' : '-';
      const offsetTotal = Math.abs(offsetMinutes);
      const offsetHours = String(Math.floor(offsetTotal / 60)).padStart(2, '0');
      const offsetMins = String(offsetTotal % 60).padStart(2, '0');

      return `${dayName} ${monthName} ${day} ${hours}:${minutes}:${seconds} ${year} ${offsetSign}${offsetHours}${offsetMins}`;
    }

    function formatGitLogBlock(commit) {
      const parts = [];
      parts.push(`commit ${commit.sha}`);

      const authorBits = [];
      if (commit.authorName) authorBits.push(commit.authorName);
      if (commit.authorEmail) authorBits.push(`<${commit.authorEmail}>`);
      parts.push(`Author: ${authorBits.join(' ') || 'Unknown'}`);
      parts.push(`Date:   ${formatCommitDate(commit.dateIso)}`);
      parts.push('');

      const message = (commit.message || '(no commit message)').trimEnd();
      const messageLines = message.split(/\r?\n/);
      messageLines.forEach(line => {
        parts.push(`    ${line}`);
      });

      if (commit.files && commit.files.length) {
        parts.push('');
        commit.files.forEach(file => parts.push(file));
      }

      return parts.join('\n');
    }

    function createCommitBase(source) {
      const commit = source?.commit || {};
      const primaryAuthor = commit.author || {};
      const fallbackAuthor = commit.committer || {};
      const userAuthor = source?.author || source?.committer || {};

      const authorName = primaryAuthor.name || userAuthor.name || userAuthor.login || fallbackAuthor.name || 'Unknown';
      const authorEmail = primaryAuthor.email || fallbackAuthor.email || '';
      const dateIso = primaryAuthor.date || fallbackAuthor.date || '';

      return {
        sha: source?.sha || '',
        shortSha: (source?.sha || '').slice(0, 7),
        authorName,
        authorEmail,
        dateIso,
        message: commit.message || '',
        htmlUrl: source?.html_url || '',
      };
    }

    function createCommitFromDetail(detail) {
      const base = createCommitBase(detail);
      const files = Array.isArray(detail?.files) ? detail.files.map(file => file.filename) : [];
      return { ...base, files };
    }

    function createCommitFromSummary(summary) {
      const base = createCommitBase(summary);
      return { ...base, files: [] };
    }

    function getAllCommits() {
      const pages = Array.from(state.pages.keys()).sort((a, b) => a - b);
      const combined = [];
      pages.forEach(pageNum => {
        const commits = state.pages.get(pageNum);
        if (Array.isArray(commits)) {
          combined.push(...commits);
        }
      });
      return combined;
    }

    function renderCommits(commits, { append = false } = {}) {
      if (!append) {
        feedListEl.innerHTML = '';
        if (!commits.length) {
          feedListEl.innerHTML = `
            <article class="card">
              <h2 class="post-title">No commits yet</h2>
              <p class="meta">The repository is quiet—check back soon.</p>
            </article>`;
          return;
        }
      }

      if (!commits.length) {
        return;
      }

      const fragment = document.createDocumentFragment();

      commits.forEach(commit => {
        const article = document.createElement('article');
        article.className = 'card';

        const fileCount = Array.isArray(commit.files) ? commit.files.length : 0;
        const infoText = fileCount
          ? `${fileCount} ${fileCount === 1 ? 'file' : 'files'} touched`
          : 'No tracked files changed';

        article.innerHTML = `
          <div class="commit-title">
            <h2 class="post-title">
              <a href="${commit.htmlUrl}" target="_blank" rel="noopener">
                commit ${escapeHtml(commit.shortSha)}
              </a>
            </h2>
            <span>${escapeHtml(infoText)}</span>
          </div>
          <p class="meta">
            Source: <a href="${COMMITS_PAGE_URL}" target="_blank" rel="noopener">${escapeHtml(`${OWNER}/${REPO}@${BRANCH}`)}</a>
          </p>
        `;

        const pre = document.createElement('pre');
        pre.className = 'git-log';
        pre.textContent = formatGitLogBlock(commit);
        article.appendChild(pre);

        const actions = document.createElement('div');
        actions.className = 'commit-actions';
        actions.innerHTML = `
          <a class="chip" href="${commit.htmlUrl}" target="_blank" rel="noopener">
            VIEW COMMIT
          </a>
        `;
        article.appendChild(actions);

        fragment.appendChild(article);
      });

      feedListEl.appendChild(fragment);
    }

    function renderLoading() {
      feedListEl.innerHTML = `
        <article class="card">
          <h2 class="post-title">Loading commits…</h2>
          <p class="meta">Contacting GitHub for the latest activity.</p>
        </article>`;
    }

    function renderError(error) {
      feedListEl.innerHTML = `
        <article class="card">
          <h2 class="post-title">Couldn’t load commits</h2>
          <p class="meta">Check the GitHub API status or try again later.</p>
          <p>${escapeHtml(String(error))}</p>
        </article>`;
    }

    function setLoadMoreStatus(message = '', isError = false) {
      if (!message) {
        loadMoreStatus.textContent = '';
        loadMoreStatus.classList.add('hidden');
        loadMoreStatus.classList.remove('error');
        return;
      }

      loadMoreStatus.textContent = message;
      loadMoreStatus.classList.toggle('error', isError);
      loadMoreStatus.classList.remove('hidden');
    }

    function updateLoadMoreControls() {
      const hasAnyCommits = getAllCommits().length > 0;
      if (state.hasMore && hasAnyCommits) {
        loadMoreContainer.classList.remove('hidden');
      } else {
        loadMoreContainer.classList.add('hidden');
      }
      loadMoreButton.disabled = state.isLoading;
      loadMoreButton.textContent = state.isLoading ? 'LOADING…' : 'LOAD MORE COMMITS';
    }

    function readCache() {
      try {
        const raw = localStorage.getItem(CACHE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return null;
        if (typeof parsed.when !== 'number') return null;
        if (!parsed.pages || typeof parsed.pages !== 'object') return null;
        if ((Date.now() - parsed.when) > CACHE_TTL_MS) return null;
        return parsed;
      } catch (err) {
        console.warn('Failed to read commit cache', err);
        return null;
      }
    }

    function writeCache(data) {
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      } catch (err) {
        console.warn('Failed to store commit cache', err);
      }
    }

    function applyCachedPages(cache) {
      state.pages.clear();

      const pageNumbers = Object.keys(cache.pages || {})
        .map(Number)
        .filter(pageNum => Number.isFinite(pageNum) && pageNum > 0)
        .sort((a, b) => a - b);

      pageNumbers.forEach(pageNum => {
        const commits = Array.isArray(cache.pages[pageNum]) ? cache.pages[pageNum] : [];
        state.pages.set(pageNum, commits);
      });

      state.currentPage = pageNumbers.length ? pageNumbers[pageNumbers.length - 1] : 0;

      const lastPageNumber = pageNumbers.length ? pageNumbers[pageNumbers.length - 1] : null;
      const lastPageSize = lastPageNumber ? (Array.isArray(cache.pages[lastPageNumber]) ? cache.pages[lastPageNumber].length : 0) : 0;
      state.hasMore = cache.hasMore !== undefined ? !!cache.hasMore : (lastPageSize === COMMITS_PER_PAGE && pageNumbers.length > 0);

      const allCommits = getAllCommits();
      if (allCommits.length) {
        renderCommits(allCommits, { append: false });
      } else if (pageNumbers.length) {
        renderCommits([], { append: false });
      } else {
        renderLoading();
      }
    }

    async function fetchCommitsPage(page) {
      const listResponse = await fetch(`${COMMITS_API_URL}&page=${page}`, { headers: API_HEADERS });
      if (!listResponse.ok) {
        throw new Error(`List request failed for page ${page}: ${listResponse.status} ${listResponse.statusText}`);
      }

      const summaries = await listResponse.json();
      if (!Array.isArray(summaries)) {
        throw new Error('Unexpected response when requesting commits.');
      }

      const commits = [];

      for (const summary of summaries) {
        try {
          const detailResponse = await fetch(summary.url, { headers: API_HEADERS });
          if (!detailResponse.ok) {
            throw new Error(`Detail request failed for ${summary.sha}: ${detailResponse.status} ${detailResponse.statusText}`);
          }
          const detail = await detailResponse.json();
          commits.push(createCommitFromDetail(detail));
        } catch (err) {
          console.warn(`Falling back to summary for commit ${summary.sha}`, err);
          commits.push(createCommitFromSummary(summary));
        }
      }

      return { commits, fetchedCount: summaries.length };
    }

    async function loadPage(page, { append = false } = {}) {
      if (state.isLoading) return;

      setLoadMoreStatus('');
      state.isLoading = true;
      updateLoadMoreControls();

      try {
        const { commits, fetchedCount } = await fetchCommitsPage(page);

        if (page === 1) {
          state.pages.clear();
          state.currentPage = 0;
        }

        state.pages.set(page, commits);
        state.currentPage = Math.max(state.currentPage, page);
        state.hasMore = fetchedCount === COMMITS_PER_PAGE;

        if (page === 1 || !append) {
          renderCommits(getAllCommits(), { append: false });
        } else {
          renderCommits(commits, { append: true });
        }

        if (page === 1) {
          cacheData.pages = {};
        }
        cacheData.pages[page] = commits;
        cacheData.hasMore = state.hasMore;
        cacheData.when = Date.now();
        writeCache(cacheData);
      } catch (err) {
        console.error(err);
        if (!getAllCommits().length) {
          renderError(err);
        } else {
          setLoadMoreStatus('Could not load more commits. Please try again.', true);
        }
      } finally {
        state.isLoading = false;
        updateLoadMoreControls();
      }
    }

    loadMoreButton.addEventListener('click', () => {
      if (state.isLoading) return;
      const nextPage = state.currentPage + 1;
      const shouldAppend = state.currentPage >= 1;
      loadPage(nextPage, { append: shouldAppend });
    });

    const cachedData = readCache();
    let cacheData = cachedData ? cachedData : { when: 0, pages: {}, hasMore: true };

    if (cachedData) {
      applyCachedPages(cachedData);
    } else {
      renderLoading();
    }

    updateLoadMoreControls();

    loadPage(1, { append: false });

    // Toggle between feed and about sections
    const aboutSection = document.getElementById('about');
    const feedSection = document.getElementById('feed');
    document.getElementById('about-btn').addEventListener('click', (e) => {
      e.preventDefault();
      feedSection.classList.add('hidden');
      aboutSection.classList.remove('hidden');
    });
    document.getElementById('feed-btn').addEventListener('click', (e) => {
      e.preventDefault();
      aboutSection.classList.add('hidden');
      feedSection.classList.remove('hidden');
    });

    // Logo flicker
    const logo = document.querySelector('.logo');
    setInterval(() => {
      const n = Math.random();
      logo.style.filter = n > 0.8 ? 'brightness(1.4)' : 'none';
      logo.classList.toggle('flicker', n > 0.85);
    }, 140);

    // Parallax background
    const rain = document.querySelector('.bg.rain');
    const fog = document.querySelector('.bg.fog');
    window.addEventListener('mousemove', (e) => {
      const x = (e.clientX / window.innerWidth - 0.5) * 10;
      const y = (e.clientY / window.innerHeight - 0.5) * 10;
      if (rain) rain.style.transform = `translate(${x}px, ${y}px)`;
      if (fog)  fog.style.transform  = `translate(${-x}px, ${-y}px)`;
    });

    // Smooth scrolling for internal links
    document.querySelectorAll('a[href^="#"]').forEach(link => {
      link.addEventListener('click', (e) => {
        const target = document.getElementById(link.getAttribute('href').slice(1));
        if (target) {
          e.preventDefault();
          target.scrollIntoView({ behavior: 'smooth' });
        }
      });
    });
  </script>
</body>
</html>
