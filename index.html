<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BUDOSTACK Blog</title>

  <!-- Fonts + Styles -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <meta name="theme-color" content="#0a0f1f">
</head>
<body>
  <!-- Background layers -->
  <div class="bg rain"></div>
  <div class="bg fog"></div>
  <div class="scanlines"></div>

  <header class="site-header">
    <div class="logo glitch" data-text="BUDOSTACK BLOG">BUDOSTACK BLOG</div>
    <p class="tag">The Martial Art of Software - For those about to Zen...</p>
    <nav class="nav">
      <a class="neon-btn" href="https://github.com/sensei-zenabi/BUDOSTACK">REPO</a>
      <a class="neon-btn" href="#about" id="about-btn">ABOUT</a>
      <a class="neon-btn" href="#feed" id="feed-btn">FEED</a>
    </nav>
  </header>

  <div class="content">
    <!-- FEED gets populated from README -->
    <main class="container" id="feed">
      <noscript>
        <article class="card">
          <h2 class="post-title"><span class="jpn">オフライン</span> JavaScript Disabled</h2>
          <p class="meta">Enable JavaScript to view the live commit feed.</p>
        </article>
      </noscript>
    </main>

    <section class="about container hidden" id="about">
      <h3 class="section-title">ABOUT // OPERATOR</h3>
      <p>
        Fun little nostalgic project to explore AI capabilities in producing code via e.g. CODEX github integration.
        <br><br>
        BUDOSTACK is a lightweight operating "layer" built atop POSIX-compliant Linux, specifically 
        designed for those who value the elegant simplicity and clarity found in operating systems of 
        the 1980s. Optimized for maximum focus and efficiency on basic primitives of computing, such as 
        file manipulation, text editing, command-line interactions, and BASIC like scripting.
        <br><br>
        Currently BUDOSTACK is in Early Access phase where users are able to explore it's capabilities
        without having a guarantee to backwards compatibility from newer versions. The final vision is
        to have a robust system that can be always upgraded using "update" command into a newer version
        using internet connection. When the time is right, the first official version will be launched
        in this website with instructions how to install it.
        <br><br>
        With these words I wish you pleasant retro vibes while using BUDOSTACK.
      </p>
      <img src="images/about.png" alt="About" class="about-photo">
    </section>
  </div>

  <footer class="site-footer">
    <p>© 2025 BUDOSTACK // Off-World Editions</p>
  </footer>

  <script>
    // ========= CONFIG =========
    const OWNER = 'sensei-zenabi';
    const REPO = 'BUDOSTACK';
    const BRANCH = 'main';
    const COMMITS_PER_PAGE = 10;

    const COMMITS_PAGE_URL = `https://github.com/${OWNER}/${REPO}/commits/${BRANCH}`;
    const COMMITS_API_BASE_URL = `https://api.github.com/repos/${OWNER}/${REPO}/commits?sha=${BRANCH}`;

    const CACHE_KEY = `commit_log_cache_v2:${OWNER}/${REPO}/${BRANCH}`;
    const CACHE_TTL_MS = 15 * 60 * 1000;
    const API_HEADERS = { 'Accept': 'application/vnd.github+json' };

    const feedEl = document.getElementById('feed');

    const state = {
      commits: [],
      page: 0,
      hasMore: true,
      isLoading: false,
      lastError: null,
    };

    const DAY_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const MONTH_NAMES = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    function escapeHtml(value = '') {
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatCommitDate(isoString) {
      if (!isoString) return 'Unknown';
      const date = new Date(isoString);
      if (Number.isNaN(date.getTime())) return isoString;

      const dayName = DAY_NAMES[date.getDay()];
      const monthName = MONTH_NAMES[date.getMonth()];
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      const year = date.getFullYear();

      const offsetMinutes = -date.getTimezoneOffset();
      const offsetSign = offsetMinutes >= 0 ? '+' : '-';
      const offsetTotal = Math.abs(offsetMinutes);
      const offsetHours = String(Math.floor(offsetTotal / 60)).padStart(2, '0');
      const offsetMins = String(offsetTotal % 60).padStart(2, '0');

      return `${dayName} ${monthName} ${day} ${hours}:${minutes}:${seconds} ${year} ${offsetSign}${offsetHours}${offsetMins}`;
    }

    function formatGitLogBlock(commit) {
      const parts = [];
      parts.push(`commit ${commit.sha}`);

      const authorBits = [];
      if (commit.authorName) authorBits.push(commit.authorName);
      if (commit.authorEmail) authorBits.push(`<${commit.authorEmail}>`);
      parts.push(`Author: ${authorBits.join(' ') || 'Unknown'}`);
      parts.push(`Date:   ${formatCommitDate(commit.dateIso)}`);
      parts.push('');

      const message = (commit.message || '(no commit message)').trimEnd();
      const messageLines = message.split(/\r?\n/);
      messageLines.forEach(line => {
        parts.push(`    ${line}`);
      });

      if (commit.files && commit.files.length) {
        parts.push('');
        commit.files.forEach(file => parts.push(file));
      }

      return parts.join('\n');
    }

    function createSanitizedCommit(detail) {
      const commit = detail.commit || {};
      const author = commit.author || commit.committer || {};
      const files = Array.isArray(detail.files) ? detail.files.map(f => f.filename) : [];

      return {
        sha: detail.sha,
        shortSha: detail.sha.slice(0, 7),
        authorName: author.name || 'Unknown',
        authorEmail: author.email || '',
        dateIso: author.date || commit.author?.date || commit.committer?.date || '',
        message: commit.message || '',
        files,
        htmlUrl: detail.html_url
      };
    }

    function createCommitCard(commit) {
      const article = document.createElement('article');
      article.className = 'card';

      const fileCount = commit.files.length;
      const infoText = fileCount
        ? `${fileCount} ${fileCount === 1 ? 'file' : 'files'} touched`
        : 'No tracked files changed';

      article.innerHTML = `
        <div class="commit-title">
          <h2 class="post-title">
            <a href="${commit.htmlUrl}" target="_blank" rel="noopener">
              commit ${escapeHtml(commit.shortSha)}
            </a>
          </h2>
          <span>${escapeHtml(infoText)}</span>
        </div>
        <p class="meta">
          Source: <a href="${COMMITS_PAGE_URL}" target="_blank" rel="noopener">${escapeHtml(`${OWNER}/${REPO}@${BRANCH}`)}</a>
        </p>
      `;

      const pre = document.createElement('pre');
      pre.className = 'git-log';
      pre.textContent = formatGitLogBlock(commit);
      article.appendChild(pre);

      const actions = document.createElement('div');
      actions.className = 'commit-actions';
      actions.innerHTML = `
        <a class="chip" href="${commit.htmlUrl}" target="_blank" rel="noopener">
          VIEW COMMIT
        </a>
      `;
      article.appendChild(actions);

      return article;
    }

    function createLoadMoreCard() {
      const card = document.createElement('article');
      card.className = 'card load-more-card';

      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'neon-btn load-more-btn';
      const count = state.commits.length;
      const canAttemptLoad = state.hasMore || count === 0;
      const buttonLabel = state.isLoading
        ? 'Loading…'
        : canAttemptLoad
          ? (count ? 'LOAD MORE COMMITS' : 'LOAD COMMITS')
          : 'ALL COMMITS LOADED';
      button.textContent = buttonLabel;
      button.disabled = state.isLoading || (!canAttemptLoad);
      button.addEventListener('click', () => loadMoreCommits());

      const status = document.createElement('p');
      status.className = 'meta status-line';
      const countLabel = `${count} ${count === 1 ? 'commit' : 'commits'}`;
      status.textContent = count ? `Showing ${countLabel}.` : 'No commits cached yet.';

      if (state.lastError) {
        const error = document.createElement('p');
        error.className = 'status-line error';
        error.textContent = `Last attempt failed: ${state.lastError}`;
        card.append(button, status, error);
      } else {
        card.append(button, status);
      }

      return card;
    }

    function renderCommits() {
      feedEl.innerHTML = '';

      if (!state.commits.length) {
        const empty = document.createElement('article');
        empty.className = 'card';
        empty.innerHTML = `
          <h2 class="post-title">No commits found</h2>
          <p class="meta">We couldn’t find any commits yet. Try loading again shortly.</p>
        `;
        feedEl.appendChild(empty);
      } else {
        const fragment = document.createDocumentFragment();
        state.commits.forEach(commit => fragment.appendChild(createCommitCard(commit)));
        feedEl.appendChild(fragment);
      }

      const loadMoreCard = createLoadMoreCard();
      feedEl.appendChild(loadMoreCard);
    }

    function renderLoading() {
      feedEl.innerHTML = `
        <article class="card">
          <h2 class="post-title">Loading commits…</h2>
          <p class="meta">Contacting GitHub for the latest activity.</p>
        </article>`;
    }

    function renderError(error) {
      feedEl.innerHTML = `
        <article class="card">
          <h2 class="post-title">Couldn’t load commits</h2>
          <p class="meta">Check the GitHub API status or try again later.</p>
          <p>${escapeHtml(String(error))}</p>
          <div class="commit-actions">
            <button type="button" class="neon-btn load-more-btn retry-btn">RETRY</button>
            <a class="chip" href="${COMMITS_PAGE_URL}" target="_blank" rel="noopener">VIEW HISTORY</a>
          </div>
        </article>`;

      const retryButton = feedEl.querySelector('.retry-btn');
      if (retryButton) {
        retryButton.addEventListener('click', () => loadMoreCommits({ replace: true }));
      }
    }

    function saveCache() {
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify({
          when: Date.now(),
          commits: state.commits,
          page: state.page,
          hasMore: state.hasMore,
        }));
      } catch (err) {
        console.warn('Failed to store commit cache', err);
      }
    }

    function restoreCache() {
      try {
        const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || 'null');
        if (!cached || !Array.isArray(cached.commits)) {
          return false;
        }

        if (typeof cached.when === 'number' && (Date.now() - cached.when) > CACHE_TTL_MS) {
          return false;
        }

        state.commits = cached.commits;
        state.page = cached.page || (state.commits.length ? 1 : 0);
        state.hasMore = typeof cached.hasMore === 'boolean' ? cached.hasMore : true;
        state.lastError = null;
        renderCommits();
        return true;
      } catch (err) {
        console.warn('Failed to read commit cache', err);
        return false;
      }
    }

    async function fetchCommitsPage(page) {
      const url = `${COMMITS_API_BASE_URL}&per_page=${COMMITS_PER_PAGE}&page=${page}`;
      const listResponse = await fetch(url, { headers: API_HEADERS });
      if (!listResponse.ok) {
        throw new Error(`List request failed: ${listResponse.status} ${listResponse.statusText}`);
      }

      const summaries = await listResponse.json();
      const linkHeader = listResponse.headers.get('link') || '';
      const hasNext = /rel="next"/.test(linkHeader);

      const commitDetails = await Promise.all(
        summaries.map(summary =>
          fetch(summary.url, { headers: API_HEADERS })
            .then(res => {
              if (!res.ok) {
                throw new Error(`Detail request failed for ${summary.sha}: ${res.status} ${res.statusText}`);
              }
              return res.json();
            })
        )
      );

      return {
        commits: commitDetails.map(createSanitizedCommit),
        hasNext,
      };
    }

    async function loadMoreCommits({ replace = false } = {}) {
      if (state.isLoading) {
        return;
      }

      const targetPage = replace ? 1 : state.page + 1;
      if (!replace && !state.hasMore && state.commits.length) {
        return;
      }

      state.lastError = null;
      state.isLoading = true;

      if (state.commits.length) {
        renderCommits();
      } else {
        renderLoading();
      }

      const previousCommits = state.commits.slice();
      const previousPage = state.page;

      try {
        const { commits: newCommits, hasNext } = await fetchCommitsPage(targetPage);
        state.lastError = null;

        if (replace) {
          const seen = new Set();
          const merged = [];
          newCommits.forEach(commit => {
            if (!seen.has(commit.sha)) {
              merged.push(commit);
              seen.add(commit.sha);
            }
          });
          previousCommits.forEach(commit => {
            if (!seen.has(commit.sha)) {
              merged.push(commit);
              seen.add(commit.sha);
            }
          });
          state.commits = merged;
          const nextPageValue = newCommits.length ? targetPage : 0;
          state.page = Math.max(previousPage, nextPageValue);
        } else if (newCommits.length) {
          const merged = previousCommits.slice();
          const seen = new Set(merged.map(commit => commit.sha));
          newCommits.forEach(commit => {
            if (!seen.has(commit.sha)) {
              merged.push(commit);
              seen.add(commit.sha);
            }
          });
          state.commits = merged;
          state.page = targetPage;
        } else {
          state.commits = previousCommits;
          state.page = previousPage;
        }

        state.hasMore = hasNext;
        if (!newCommits.length && !hasNext) {
          state.hasMore = false;
        }

        saveCache();
      } catch (err) {
        console.error(err);
        state.lastError = err instanceof Error ? err.message : String(err);
        if (!state.commits.length) {
          renderError(state.lastError);
        }
      } finally {
        state.isLoading = false;
        if (state.commits.length || (!state.commits.length && !state.lastError)) {
          renderCommits();
        }
      }
    }

    const hadCache = restoreCache();
    if (!hadCache) {
      renderLoading();
    }

    loadMoreCommits({ replace: true });

    // Toggle between feed and about sections
    const aboutSection = document.getElementById('about');
    const feedSection = document.getElementById('feed');
    document.getElementById('about-btn').addEventListener('click', (e) => {
      e.preventDefault();
      feedSection.classList.add('hidden');
      aboutSection.classList.remove('hidden');
    });
    document.getElementById('feed-btn').addEventListener('click', (e) => {
      e.preventDefault();
      aboutSection.classList.add('hidden');
      feedSection.classList.remove('hidden');
    });

    // Logo flicker
    const logo = document.querySelector('.logo');
    setInterval(() => {
      const n = Math.random();
      logo.style.filter = n > 0.8 ? 'brightness(1.4)' : 'none';
      logo.classList.toggle('flicker', n > 0.85);
    }, 140);

    // Parallax background
    const rain = document.querySelector('.bg.rain');
    const fog = document.querySelector('.bg.fog');
    window.addEventListener('mousemove', (e) => {
      const x = (e.clientX / window.innerWidth - 0.5) * 10;
      const y = (e.clientY / window.innerHeight - 0.5) * 10;
      if (rain) rain.style.transform = `translate(${x}px, ${y}px)`;
      if (fog)  fog.style.transform  = `translate(${-x}px, ${-y}px)`;
    });

    // Smooth scrolling for internal links
    document.querySelectorAll('a[href^="#"]').forEach(link => {
      link.addEventListener('click', (e) => {
        const target = document.getElementById(link.getAttribute('href').slice(1));
        if (target) {
          e.preventDefault();
          target.scrollIntoView({ behavior: 'smooth' });
        }
      });
    });
  </script>
</body>
</html>
